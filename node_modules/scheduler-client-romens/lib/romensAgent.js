/*****************************************************************
 * 青岛雨人软件有限公司©2016版权所有
 *
 * 本软件之所有（包括但不限于）源代码、设计图、效果图、动画、日志、
 * 脚本、数据库、文档均为青岛雨人软件或其附属子公司所有。任何组织
 * 或者个人，未经青岛雨人软件书面授权，不得复制、使用、修改、分发、
 * 公布本软件的任何部分。青岛雨人软件有限公司保留对任何违反本声明
 * 的组织和个人采取法律手段维护合法权益的权利。
 *****************************************************************/

var superAgent = require('superagent');
var Logger = require('logger-romens');
var option = {
    level: "DEBUG"
};
var logger = new Logger(option);
function RomensAgent() {
}

//swagger接口支持该格式数据
RomensAgent.prototype.sendJson= function (method, url, data, callback){
        var methodFunc = (method =='get') ? 'query' : 'send';
        superAgent[method](url)[methodFunc](data)
            .set('content-type', 'application/json')
            .set('Accept', 'application/json')
            .timeout(120000)
            .end(function superAgentCallback(error, res) {
                logger.info('SuperAgentCallbacked!');
                if(error&&error.code){
                  logger.info('superAgentCallback:' + error +'\n');
                    if(error){
                        logger.error("romensAgent err :"+error);
                    }
                    callback(error)
                }else if (res&&res.ok) {
                    logger.trace('发送消息的返回值:'+ (res.text.length > 20000
                        ? res.text.substr(0,20000) + '......' : res.text));
                    var resData = "";
                    if(typeof res.text == 'object'){
                        try {
                            resData = JSON.parse(res.text);
                        } catch (exception){
                            return callback(exception);
                        }
                    }else {
                            resData = res.text
                    }
                    logger.trace('after send msg, feedback:'+ JSON.stringify(resData).length > 20000
                        ? JSON.stringify(resData).substr(0,20000) + '......' : JSON.stringify(resData));
                    callback(null,resData);
                }else{
                    logger.warn("其他未定义的处理"+JSON.stringify(res));
                    callback(error,res)
                }
            });

};
module.exports = RomensAgent;